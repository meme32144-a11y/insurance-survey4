<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ค้นพบพิมพ์เขียวแห่งชีวิตของคุณ | Life Blueprint Survey</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4A69BD; /* Royal Blue */
            --secondary-color: #6A89CC; /* Light Blue */
            --accent-color: #F6B93B; /* Yellow */
            --danger-color: #e74c3c;
            --bg-color: #F7F9FC;
            --text-color: #333D49;
            --light-gray: #EAECEF;
            --white: #FFFFFF;
            --border-radius-lg: 16px;
            --border-radius-md: 12px;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            --transition: all 0.3s ease-in-out;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.8;
        }

        .main-container {
            max-width: 750px;
            margin: 2rem auto;
            padding: 1rem;
        }

        .survey-card {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.6s forwards;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        .survey-chapter {
            display: none;
            padding: 2rem 2.5rem;
        }

        .survey-chapter.active { 
            display: block; 
            animation: slideIn 0.5s forwards;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(15px); }
            to { opacity: 1; transform: translateX(0); }
        }

        h2.chapter-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 2rem;
            font-size: 1.8rem;
        }
        
        .question-group { 
            margin-bottom: 2.5rem; 
            padding: 1rem;
            border-radius: var(--border-radius-md);
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .question-group.invalid {
            animation: shake 0.5s;
            border-color: var(--danger-color);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .form-label { font-weight: 600; font-size: 1.1rem; margin-bottom: 1rem; }

        /* Custom Input Styles */
        .image-card-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .image-card { border: 2px solid var(--light-gray); border-radius: var(--border-radius-md); padding: 1rem; text-align: center; cursor: pointer; transition: var(--transition); position: relative; }
        .image-card img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 0.5rem; }
        .image-card .form-check-input { position: absolute; top: 10px; right: 10px; width: 1.5em; height: 1.5em; }
        .image-card:hover { transform: translateY(-5px); border-color: var(--secondary-color); }
        input[type="radio"]:checked + .image-card { border-color: var(--primary-color); background-color: #F7F9FC; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .choice-selector .form-check { margin-bottom: 0.5rem; }
        .choice-selector .form-check-input { margin-top: 0.4em; }

        .slider-container { text-align: center; }
        .slider-container input[type="range"] { width: 100%; }
        .slider-labels { display: flex; justify-content: space-between; font-size: 0.9rem; color: #888; margin-top: 0.5rem; }
        
        .icon-checkbox-group .form-check { display: flex; align-items: center; margin-bottom: 0.75rem; }
        .icon-checkbox-group .icon { margin-right: 10px; color: var(--primary-color); width: 20px; text-align: center; }
        
        /* Navigation & Progress */
        .progress-container { padding: 1.5rem 2.5rem 0.5rem; }
        .progress { height: 8px; border-radius: 4px; background-color: var(--light-gray); }
        .progress-bar { background: linear-gradient(90deg, var(--secondary-color), var(--primary-color)); }
        #chapterCounter { font-size: 0.9rem; color: #6c757d; }

        .navigation-footer { padding: 1.5rem 2.5rem; background-color: #F7F9FC; border-top: 1px solid var(--light-gray); }
        .btn-custom { padding: 0.8rem 1.8rem; font-weight: 600; border-radius: var(--border-radius-md); transition: var(--transition); border: none; }
        .btn-next { background-color: var(--primary-color); color: var(--white); }
        .btn-next:hover { background-color: #3b5699; }
        .btn-prev { background-color: var(--light-gray); color: var(--text-color); }

        /* Blueprint/Report Section */
        #blueprint-container { text-align: center; padding: 3rem 1.5rem; }
        #gemini-report h3 { color: var(--primary-color); font-weight: bold; margin-top: 2rem; }
        #gemini-report .report-section { background: var(--white); padding: 1.5rem; border-radius: var(--border-radius-md); margin-bottom: 1rem; text-align: left; border-left: 5px solid; }
        
        /* CTA Section */
        #cta-section { background-color: var(--light-gray); padding: 2rem; border-radius: var(--border-radius-md); margin-top: 2rem; }
        #cta-section h4 { font-weight: 600; margin-bottom: 1.5rem; }
        .cta-btn { width: 100%; text-align: left; padding: 1rem; margin-bottom: 0.75rem; background-color: var(--white); border-radius: var(--border-radius-md); }
        .cta-btn .cta-title { font-weight: 600; }
        .cta-btn .cta-desc { font-size: 0.9rem; }

    </style>
</head>
<body>

    <div class="main-container">
        <div class="survey-card">

            <!-- Welcome Screen (Chapter 0) -->
            <div id="chapter-0" class="survey-chapter active text-center">
                <i class="fas fa-map-signs fa-3x mb-4" style="color: var(--primary-color);"></i>
                <h2 class="chapter-title">เริ่มต้นการเดินทางสู่ "พิมพ์เขียวแห่งชีวิต"</h2>
                <p class="text-muted">มาใช้เวลาสั้นๆ เพื่อสำรวจเส้นทางชีวิตของคุณ ทั้งในปัจจุบันและอนาคตที่วาดฝันไว้ แบบสอบถามนี้จะช่วยให้คุณมองเห็นภาพรวมและเตรียมพร้อมสำหรับทุกก้าวต่อไป</p>
                <button id="startButton" class="btn btn-custom btn-next mt-4">เริ่มต้นกันเลย!</button>
            </div>

            <form id="surveyForm" novalidate>
                <!-- Progress Bar (shown after start) -->
                <div id="progress-wrapper" class="progress-container d-none">
                    <div class="d-flex justify-content-between mb-1">
                        <span id="chapterName" class="fw-bold" style="color: var(--primary-color);"></span>
                        <span id="chapterCounter"></span>
                    </div>
                    <div class="progress">
                        <div id="progressBar" class="progress-bar" role="progressbar"></div>
                    </div>
                </div>

                <!-- Chapter 1: Your Current Snapshot -->
                <div id="chapter-1" class="survey-chapter" data-name="ภาพร่างปัจจุบัน">
                    <h2 class="chapter-title">Chapter 1: ภาพร่างปัจจุบันของคุณ</h2>
                    <div class="question-group">
                        <label class="form-label">1. ไลฟ์สไตล์ที่ใกล้เคียงกับคุณที่สุดในตอนนี้คือ?</label>
                        <div class="image-card-selector">
                            <div><input type="radio" class="form-check-input" name="lifestyle" value="นักรบออฟฟิศ" id="lifestyle1" required><label for="lifestyle1" class="image-card"><img src="https://images.unsplash.com/photo-1522071820081-009f0129c71c?q=80&w=400&auto=format&fit=crop" alt="Office Worker"><span>นักรบออฟฟิศ</span></label></div>
                            <div><input type="radio" class="form-check-input" name="lifestyle" value="ฟรีแลนซ์/สายชิล" id="lifestyle2"><label for="lifestyle2" class="image-card"><img src="https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?q=80&w=400&auto=format&fit=crop" alt="Freelancer"><span>ฟรีแลนซ์/สายชิล</span></label></div>
                            <div><input type="radio" class="form-check-input" name="lifestyle" value="เจ้าของธุรกิจ" id="lifestyle3"><label for="lifestyle3" class="image-card"><img src="https://images.unsplash.com/photo-1556761175-5973dc0f32e7?q=80&w=400&auto=format&fit=crop" alt="Business Owner"><span>เจ้าของธุรกิจ</span></label></div>
                            <div><input type="radio" class="form-check-input" name="lifestyle" value="คุณพ่อ/คุณแม่ฟูลไทม์" id="lifestyle4"><label for="lifestyle4" class="image-card"><img src="https://images.unsplash.com/photo-1488509082103-a912c7104b32?q=80&w=400&auto=format&fit=crop" alt="Full-time Parent"><span>คุณพ่อ/คุณแม่</span></label></div>
                        </div>
                    </div>
                    <div class="question-group">
                        <label for="work_life_balance" class="form-label">2. คุณให้คะแนน Work-Life Balance ของตัวเองเท่าไหร่?</label>
                        <div class="slider-container">
                            <input type="range" class="form-range" id="work_life_balance" name="work_life_balance" min="0" max="10" step="1" value="5">
                            <div class="slider-labels"><span>ต้องการกาแฟด่วน!</span><span>สบายๆ ชิลๆ</span></div>
                        </div>
                    </div>
                    <div class="question-group">
                        <label class="form-label">3. สถานะทางการเงินในปัจจุบันของคุณเป็นอย่างไร?</label>
                        <div class="choice-selector">
                           <div class="form-check"><input class="form-check-input" type="radio" name="financial_status" id="fs1" value="กำลังสร้างตัว" required><label class="form-check-label" for="fs1">กำลังสร้างตัว</label></div>
                           <div class="form-check"><input class="form-check-input" type="radio" name="financial_status" id="fs2" value="เริ่มมั่นคง"><label class="form-check-label" for="fs2">เริ่มมั่นคง</label></div>
                           <div class="form-check"><input class="form-check-input" type="radio" name="financial_status" id="fs3" value="อยู่ตัวแล้ว"><label class="form-check-label" for="fs3">อยู่ตัวแล้ว</label></div>
                        </div>
                    </div>
                    <div class="question-group">
                         <label class="form-label">4. คุณมีภาระผูกพันอะไรบ้างที่ต้องดูแลอยู่?</label>
                         <div class="icon-checkbox-group">
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="obligations" value="ผ่อนบ้าน" id="ob1"><label class="form-check-label" for="ob1"><i class="fas fa-home icon"></i>ผ่อนบ้าน</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="obligations" value="ผ่อนรถ" id="ob2"><label class="form-check-label" for="ob2"><i class="fas fa-car icon"></i>ผ่อนรถ</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="obligations" value="บัตรเครดิต" id="ob3"><label class="form-check-label" for="ob3"><i class="fas fa-credit-card icon"></i>บัตรเครดิต</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="obligations" value="ดูแลครอบครัว" id="ob4"><label class="form-check-label" for="ob4"><i class="fas fa-users icon"></i>ดูแลครอบครัว</label></div>
                         </div>
                    </div>
                </div>

                <!-- Chapter 2: Your Inner Circle -->
                <div id="chapter-2" class="survey-chapter" data-name="คนสำคัญในชีวิต">
                    <h2 class="chapter-title">Chapter 2: คนสำคัญในชีวิตของคุณ</h2>
                    <div class="question-group">
                         <label class="form-label">1. ใครคือคนสำคัญที่อยู่ในความดูแลของคุณ?</label>
                         <div class="icon-checkbox-group">
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="dependents" value="ตัวเราเองในอนาคต" id="dep1"><label class="form-check-label" for="dep1"><i class="fas fa-user-clock icon"></i>ตัวเราเองในอนาคต</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="dependents" value="คู่สมรส" id="dep2"><label class="form-check-label" for="dep2"><i class="fas fa-heart icon"></i>คู่สมรส</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="dependents" value="ลูก" id="dep3"><label class="form-check-label" for="dep3"><i class="fas fa-child icon"></i>ลูก</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="dependents" value="คุณพ่อคุณแม่" id="dep4"><label class="form-check-label" for="dep4"><i class="fas fa-user-friends icon"></i>คุณพ่อคุณแม่</label></div>
                         </div>
                    </div>
                    <div id="children_questions" class="question-group d-none">
                        <label class="form-label">2. (สำหรับคุณพ่อคุณแม่) คุณวาดฝันอนาคตการศึกษาของลูกไว้อย่างไร?</label>
                        <div class="choice-selector">
                           <div class="form-check"><input class="form-check-input" type="radio" name="education_dream" id="ed1" value="เรียนในประเทศ"><label class="form-check-label" for="ed1">หลักสูตรคุณภาพในประเทศ</label></div>
                           <div class="form-check"><input class="form-check-input" type="radio" name="education_dream" id="ed2" value="เรียนต่างประเทศ"><label class="form-check-label" for="ed2">เปิดประสบการณ์ในต่างประเทศ</label></div>
                           <div class="form-check"><input class="form-check-input" type="radio" name="education_dream" id="ed3" value="ตามความถนัดของลูก"><label class="form-check-label" for="ed3">สนับสนุนตามความฝัน/ความถนัดของลูก</label></div>
                        </div>
                    </div>
                    <div class="question-group">
                        <label for="legacy" class="form-label">3. คุณอยากมอบอะไรเป็นมรดกให้คนข้างหลัง (นอกเหนือจากเงิน)?</label>
                        <textarea class="form-control" name="legacy" id="legacy" rows="3" placeholder="เช่น ความรู้, ธุรกิจครอบครัว, ความมั่นคง..."></textarea>
                    </div>
                </div>

                <!-- Chapter 3: Your Future Goals -->
                <div id="chapter-3" class="survey-chapter" data-name="เป้าหมายในอนาคต">
                    <h2 class="chapter-title">Chapter 3: ภาพฝันและเป้าหมายในอนาคต</h2>
                    <div class="question-group">
                        <label class="form-label">1. อีก 10 ปีข้างหน้า คุณอยากเห็นตัวเองอยู่ที่ไหน?</label>
                        <div class="image-card-selector">
                             <div><input type="radio" class="form-check-input" name="ten_year_vision" value="มีบ้านในฝัน" id="vision1" required><label for="vision1" class="image-card"><img src="https://images.unsplash.com/photo-1568605114967-8130f3a36994?q=80&w=400&auto=format&fit=crop" alt="Dream House"><span>มีบ้านในฝัน</span></label></div>
                             <div><input type="radio" class="form-check-input" name="ten_year_vision" value="ท่องเที่ยวรอบโลก" id="vision2"><label for="vision2" class="image-card"><img src="https://images.unsplash.com/photo-1503220317375-aaad61436b1b?q=80&w=400&auto=format&fit=crop" alt="Travel"><span>ท่องเที่ยวรอบโลก</span></label></div>
                             <div><input type="radio" class="form-check-input" name="ten_year_vision" value="เป็นเจ้าของธุรกิจ" id="vision3"><label for="vision3" class="image-card"><img src="https://images.unsplash.com/photo-1522202176988-66273c2fd55f?q=80&w=400&auto=format&fit=crop" alt="Business"><span>เป็นเจ้าของธุรกิจ</span></label></div>
                             <div><input type="radio" class="form-check-input" name="ten_year_vision" value="เกษียณอย่างมีความสุข" id="vision4"><label for="vision4" class="image-card"><img src="https://images.unsplash.com/photo-1543269865-cbf427effbad?q=80&w=400&auto=format&fit=crop" alt="Retirement"><span>เกษียณอย่างมีความสุข</span></label></div>
                        </div>
                    </div>
                    <div class="question-group">
                        <label class="form-label">2. แผนเกษียณในฝันของคุณเป็นแบบไหน?</label>
                        <div class="choice-selector">
                           <div class="form-check"><input class="form-check-input" type="radio" name="retirement_dream" id="rd1" value="เกษียณเร็ว ทำสิ่งที่รัก" required><label class="form-check-label" for="rd1">เกษียณเร็ว ทำสิ่งที่รัก</label></div>
                           <div class="form-check"><input class="form-check-input" type="radio" name="retirement_dream" id="rd2" value="ทำงานอดิเรกไปเรื่อยๆ"><label class="form-check-label" for="rd2">ทำงานอดิเรกไปเรื่อยๆ</label></div>
                           <div class="form-check"><input class="form-check-input" type="radio" name="retirement_dream" id="rd3" value="ใช้ชีวิตเรียบง่าย"><label class="form-check-label" for="rd3">ใช้ชีวิตเรียบง่าย</label></div>
                        </div>
                    </div>
                    <div class="question-group">
                        <label class="form-label">3. หากมีเงินก้อนหนึ่ง คุณจะนำไปทำอะไรเป็นอย่างแรก?</label>
                        <div class="choice-selector">
                           <div class="form-check"><input class="form-check-input" type="radio" name="lump_sum_action" id="lsa1" value="ลงทุน" required><label class="form-check-label" for="lsa1">ลงทุนให้งอกเงย</label></div>
                           <div class="form-check"><input class="form-check-input" type="radio" name="lump_sum_action" id="lsa2" value="ปิดหนี้"><label class="form-check-label" for="lsa2">ปิดหนี้สิน</label></div>
                           <div class="form-check"><input class="form-check-input" type="radio" name="lump_sum_action" id="lsa3" value="ให้รางวัลชีวิต"><label class="form-check-label" for="lsa3">ให้รางวัลชีวิต</label></div>
                           <div class="form-check"><input class="form-check-input" type="radio" name="lump_sum_action" id="lsa4" value="เก็บสำรองฉุกเฉิน"><label class="form-check-label" for="lsa4">เก็บเป็นเงินสำรองฉุกเฉิน</label></div>
                        </div>
                    </div>
                </div>

                <!-- Chapter 4: Navigating Life's 'What Ifs' -->
                <div id="chapter-4" class="survey-chapter" data-name="รับมือเรื่องไม่คาดฝัน">
                    <h2 class="chapter-title">Chapter 4: เตรียมพร้อมรับมือกับเรื่องไม่คาดฝัน</h2>
                    <div class="question-group">
                         <label class="form-label">1. หากพรุ่งนี้ต้องเข้ารักษาตัวในโรงพยาบาล สิ่งที่คุณกังวลที่สุดคืออะไร?</label>
                         <div class="icon-checkbox-group">
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="hospital_worry" value="ค่ารักษาพยาบาล" id="hw1"><label class="form-check-label" for="hw1"><i class="fas fa-file-invoice-dollar icon"></i>ค่ารักษาพยาบาล</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="hospital_worry" value="ขาดรายได้" id="hw2"><label class="form-check-label" for="hw2"><i class="fas fa-briefcase-medical icon"></i>ขาดรายได้ช่วงที่พักฟื้น</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" name="hospital_worry" value="ไม่มีคนดูแลครอบครัว" id="hw3"><label class="form-check-label" for="hw3"><i class="fas fa-users-slash icon"></i>ไม่มีคนดูแลครอบครัว</label></div>
                         </div>
                    </div>
                    <div class="question-group">
                        <label for="emergency_fund" class="form-label">2. คุณมีเงินสำรองฉุกเฉินเพียงพอสำหรับค่าใช้จ่ายกี่เดือน?</label>
                        <div class="slider-container">
                            <input type="range" class="form-range" id="emergency_fund" name="emergency_fund" min="0" max="12" step="1" value="3">
                            <div class="slider-labels"><span>0 เดือน</span><span>12+ เดือน</span></div>
                        </div>
                    </div>
                    <div class="question-group">
                        <label class="form-label">3. คุณมีแผนสำรองไว้ดูแลครอบครัวแล้วหรือยัง หากเกิดเหตุไม่คาดฝันกับคุณ?</label>
                         <div class="choice-selector">
                           <div class="form-check"><input class="form-check-input" type="radio" name="family_backup_plan" id="bp1" value="ยังไม่ได้คิด" required><label class="form-check-label" for="bp1">ยังไม่ได้คิดเลย</label></div>
                           <div class="form-check"><input class="form-check-input" type="radio" name="family_backup_plan" id="bp2" value="มีบ้างแล้ว"><label class="form-check-label" for="bp2">มีเตรียมไว้บ้างแล้ว</label></div>
                           <div class="form-check"><input class="form-check-input" type="radio" name="family_backup_plan" id="bp3" value="เตรียมไว้พร้อมแล้ว"><label class="form-check-label" for="bp3">เตรียมไว้ค่อนข้างพร้อม</label></div>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div id="navigation-wrapper" class="navigation-footer d-none justify-content-between align-items-center">
                    <button id="prevButton" type="button" class="btn btn-custom btn-prev"><i class="fas fa-arrow-left me-2"></i>ย้อนกลับ</button>
                    <button id="nextButton" type="button" class="btn btn-custom btn-next">ถัดไป<i class="fas fa-arrow-right ms-2"></i></button>
                    <button id="submitButton" type="submit" class="btn btn-custom btn-next d-none">สร้างพิมพ์เขียวของฉัน!</button>
                </div>
            </form>

            <!-- Blueprint Result Screen (Chapter 5) -->
             <div id="chapter-5" class="survey-chapter" data-name="พิมพ์เขียวของคุณ">
                <div id="blueprint-container">
                    <div id="loading-spinner">
                        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">กำลังสร้างพิมพ์เขียวแห่งชีวิตสำหรับคุณโดยเฉพาะ...</p>
                    </div>
                    <div id="gemini-report" class="d-none">
                        <!-- Gemini AI Report will be injected here -->
                    </div>
                </div>
                
                <div id="cta-section" class="d-none">
                     <h4>ก้าวต่อไปบนเส้นทางของคุณ</h4>
                     <p class="text-muted">เลือกเส้นทางที่เหมาะกับคุณเพื่อทำให้พิมพ์เขียวนี้เป็นจริง</p>
                    <a href="javascript:void(0)" id="cta-download" class="btn cta-btn d-flex align-items-center"><i class="fas fa-file-pdf fa-2x me-3 text-danger"></i><div><div class="cta-title">ดาวน์โหลดพิมพ์เขียว (PDF)</div><div class="cta-desc">เก็บสรุปแผนของคุณไว้พิจารณา (ฟังก์ชันเร็วๆ นี้)</div></div></a>
                    <a href="https://line.me/ti/p/yg4Aoo_5LK" id="cta-line" class="btn cta-btn d-flex align-items-center" target="_blank"><i class="fab fa-line fa-2x me-3" style="color: #00B900;"></i><div><div class="cta-title">ปรึกษาเบื้องต้นผ่าน LINE</div><div class="cta-desc">สอบถามข้อสงสัยเพิ่มเติมกับที่ปรึกษา</div></div></a>
                    <a href="https://calendly.com/first14102539" id="cta-calendly" class="btn cta-btn d-flex align-items-center" target="_blank"><i class="fas fa-calendar-check fa-2x me-3 text-primary"></i><div><div class="cta-title">นัดเวลาคุยกับที่ปรึกษา</div><div class="cta-desc">วางแผนอย่างจริงจัง (15 นาที ไม่มีค่าใช้จ่าย)</div></div></a>
                </div>
             </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzlr7zZzqT1OV3BCT-QrPe-pNM92xUoXchApa3WOaAu-eZsPhHC9_BH75ADrqhn2O4qWg/exec'; // <-- IMPORTANT: REPLACE THIS

        let currentChapter = 0;
        const chapters = document.querySelectorAll('.survey-chapter');
        const form = document.getElementById('surveyForm');
        
        const startButton = document.getElementById('startButton');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const submitButton = document.getElementById('submitButton');

        // UI Elements
        const progressWrapper = document.getElementById('progress-wrapper');
        const navigationWrapper = document.getElementById('navigation-wrapper');
        const progressBar = document.getElementById('progressBar');
        const chapterName = document.getElementById('chapterName');
        const chapterCounter = document.getElementById('chapterCounter');
        
        const blueprintContainer = document.getElementById('blueprint-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const geminiReport = document.getElementById('gemini-report');
        const ctaSection = document.getElementById('cta-section');

        let formData = {};

        function updateUI() {
            chapters.forEach((chapter, index) => {
                chapter.classList.toggle('active', index === currentChapter);
            });
            
            const totalFormChapters = 4;

            if (currentChapter > 0 && currentChapter <= totalFormChapters) {
                progressWrapper.classList.remove('d-none');
                navigationWrapper.classList.remove('d-none');
                
                const activeChapterElement = chapters[currentChapter];
                const progress = ((currentChapter - 1) / (totalFormChapters - 1)) * 100;
                
                progressBar.style.width = `${progress}%`;
                chapterName.textContent = activeChapterElement.dataset.name;
                chapterCounter.textContent = `ขั้นตอนที่ ${currentChapter} จาก ${totalFormChapters}`;
                
                const isFirstChapter = currentChapter === 1;
                const isLastFormChapter = currentChapter === totalFormChapters;

                prevButton.classList.toggle('d-none', isFirstChapter);
                
                // --- DEFINITIVE BUTTON LOGIC FIX ---
                if (isLastFormChapter) {
                    nextButton.classList.add('d-none');
                    submitButton.classList.remove('d-none');
                } else {
                    nextButton.classList.remove('d-none');
                    submitButton.classList.add('d-none');
                }
                
                navigationWrapper.style.justifyContent = isFirstChapter ? 'flex-end' : 'space-between';
            } else {
                progressWrapper.classList.add('d-none');
                navigationWrapper.classList.add('d-none');
            }
        }
        
        function navigateTo(chapterIndex) {
            if (chapterIndex >= 0 && chapterIndex < chapters.length) {
                currentChapter = chapterIndex;
                updateUI();
            }
        }

        function validateChapter(chapterIndex) {
            const chapter = chapters[chapterIndex];
            const requiredInputs = chapter.querySelectorAll('[required]');
            let isValid = true;
            
            requiredInputs.forEach(input => {
                const questionGroup = input.closest('.question-group');
                questionGroup.classList.remove('invalid'); // Reset validation style

                let isGroupValid = true;
                if (input.type === 'radio') {
                    const radioGroup = chapter.querySelectorAll(`input[name="${input.name}"]`);
                    isGroupValid = Array.from(radioGroup).some(r => r.checked);
                } else {
                    isGroupValid = input.checkValidity();
                }

                if (!isGroupValid) {
                    if(questionGroup) {
                        questionGroup.classList.add('invalid');
                        setTimeout(() => questionGroup.classList.remove('invalid'), 600);
                    }
                    isValid = false;
                }
            });
            return isValid;
        }
        
        function updateFormData() {
            const data = new FormData(form);
            formData = {};
            for (const [key, value] of data.entries()) {
                if (formData[key]) {
                    if (!Array.isArray(formData[key])) {
                        formData[key] = [formData[key]];
                    }
                    formData[key].push(value);
                } else {
                    formData[key] = value;
                }
            }
            form.querySelectorAll('input[type="range"]').forEach(slider => {
                formData[slider.name] = slider.value;
            });
        }
        
        async function submitSurvey() {
            navigateTo(5); // Go to the loading/blueprint chapter
            
            try {
                const payload = { ...formData };
                payload._submittedAt = new Date().toISOString();
                
                if (GOOGLE_APPS_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                   throw new Error("กรุณาตั้งค่า GOOGLE_APPS_SCRIPT_URL ในโค้ดก่อนใช้งาน");
                }

                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`เกิดข้อผิดพลาดจากเซิร์ฟเวอร์: ${response.status}. ${errorText}`);
                }
                
                const result = await response.json();

                if (result.result === 'success' && result.report) {
                    geminiReport.innerHTML = result.report;
                    loadingSpinner.classList.add('d-none');
                    geminiReport.classList.remove('d-none');
                    ctaSection.classList.remove('d-none');
                } else {
                   throw new Error(result.message || 'ไม่สามารถสร้างรายงานได้');
                }

            } catch (err) {
                loadingSpinner.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle fa-2x"></i><p class="mt-2">ขออภัย, เกิดข้อผิดพลาด</p><small>${err.message}</small></div>`;
            }
        }

        // Event Listeners
        startButton.addEventListener('click', () => navigateTo(1));
        prevButton.addEventListener('click', () => navigateTo(currentChapter - 1));
        nextButton.addEventListener('click', () => {
            if (validateChapter(currentChapter)) {
                navigateTo(currentChapter + 1);
            }
        });
        
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            if (validateChapter(currentChapter)) {
                updateFormData();
                submitSurvey();
            }
        });
        
        // Conditional logic for children questions
        document.querySelectorAll('input[name="dependents"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const hasChildren = document.querySelector('input[name="dependents"][value="ลูก"]').checked;
                document.getElementById('children_questions').classList.toggle('d-none', !hasChildren);
            });
        });
        
        // Initial setup
        updateUI();
    });
    </script>
</body>
</html>

